<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<title>User Profile Sample: Data Sync Fundamentals</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>User Profile Sample: Data Sync Fundamentals</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#system-overview">System Overview</a></li>
<li><a href="#app-installation">App Installation</a>
<ul class="sectlevel2">
<li><a href="#fetching-app-source-code">Fetching App Source Code</a>
<ul class="sectlevel3">
<li><a href="#option-1-git-clone">Option 1 : Git Clone</a></li>
<li><a href="#option-2-download-zip">Option 2 : Download .zip</a></li>
</ul>
</li>
<li><a href="#try-it-out">Try it Out</a></li>
</ul>
</li>
<li><a href="#sync-gateway-2-x-installation">Sync Gateway 2.x Installation</a>
<ul class="sectlevel2">
<li><a href="#download-the-installer">Download the Installer</a></li>
<li><a href="#try-it-out-2">Try it Out</a></li>
</ul>
</li>
<li><a href="#solution-overview">Solution Overview</a></li>
<li><a href="#couchbase-lite-nuget">Couchbase Lite Nuget</a></li>
<li><a href="#data-model">Data Model</a>
<ul class="sectlevel2">
<li><a href="#the-user-profile-document">The "User Profile" Document</a></li>
<li><a href="#userprofile">UserProfile</a></li>
</ul>
</li>
<li><a href="#the-university-document">The "University" Document</a>
<ul class="sectlevel2">
<li><a href="#universityrecord">UniversityRecord</a></li>
</ul>
</li>
<li><a href="#sync-gateway-configuration">Sync Gateway Configuration</a></li>
<li><a href="#sync-function">Sync Function</a>
<ul class="sectlevel2">
<li><a href="#authorization">Authorization</a></li>
<li><a href="#data-validation">Data Validation</a></li>
<li><a href="#data-routing">Data Routing</a></li>
<li><a href="#access-control">Access Control</a></li>
</ul>
</li>
<li><a href="#starting-replication">Starting Replication</a></li>
<li><a href="#stopping-replication">Stopping Replication</a></li>
<li><a href="#query-events-live-queries">Query Events / Live Queries</a></li>
<li><a href="#exercises">Exercises</a>
<ul class="sectlevel2">
<li><a href="#exercise-1">Exercise 1</a></li>
<li><a href="#exercise-2">Exercise 2</a></li>
</ul>
</li>
<li><a href="#handling-conflicts-during-data-syncronization">Handling Conflicts during Data Syncronization</a></li>
<li><a href="#learn-more">Learn More</a>
<ul class="sectlevel2">
<li><a href="#further-reading">Further Reading</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<!-- toc disabled -->
</div>
</div>
<div class="sect1">
<h2 id="introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Couchbase Sync Gateway is a key component of the Couchbase Mobile stack. It is an internet-facing synchronization mechanism that securely syncs data across devices as well as between devices and the cloud. Couchbase Mobile 2.x introduces a brand new websockets based <a href="https://blog.couchbase.com/data-replication-couchbase-mobile/">replication protocol</a>.</p>
</div>
<div class="paragraph">
<p>The core functions of the Sync Gateway include</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Data Synchronization across devices and the cloud</p>
</li>
<li>
<p>Authorization &amp; Access Control</p>
</li>
<li>
<p>Data Validation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This tutorial will demonstrate how to -</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Setup the Couchbase Sync Gateway (in walrus mode) to sync content between multiple Couchbase Lite enabled clients. We will will cover the basics of the <a href="https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/config-properties/index.html">Sync Gateway Configuration</a>.</p>
</li>
<li>
<p>Configure your Sync Gateway to enforce data routing, access control and authorization. We will cover the basics of <a href="https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/sync-function-api-guide/index.html">Sync Function API</a>.</p>
</li>
<li>
<p>Configure your Couchbase Lite clients for replication with the Sync Gateway.</p>
</li>
<li>
<p>Use "Live Queries" or Query events within your Couchbase Lite clients to be asyncronously notified of changes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We will be using Xamarin (iOS/Android/UWP) apps as examples of Couchbase Lite enabled clients.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>You can learn more about the Sync Gateway <a href="https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/index.html">here</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="prerequisites">Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This tutorial assumes familiarity with building Xamarin apps using C#, XAML, and Couchbase Lite.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you are unfamiliar with the basics of Couchbase Lite, it is recommended that you walk through the following tutorials</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.couchbase.com/userprofile-couchbase-mobile/standalone/userprofile/xamarin/userprofile_basic.html">Fundamentals</a> of using Couchbase Lite 2.0 as a standalone database</p>
</li>
<li>
<p><a href="https://docs.couchbase.com/userprofile-couchbase-mobile/query/userprofile/xamarin/userprofile_query.html">Query Basics</a> with a prebuilt version of Couchbase Lite database</p>
</li>
</ul>
</div>
</li>
<li>
<p>iOS (Xcode 10.0+)</p>
</li>
<li>
<p>Android (SDK 21+)</p>
</li>
<li>
<p>UWP (Windows 10)</p>
</li>
<li>
<p>git (Optional)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is required if you would prefer to pull the source code from GitHub repo.
<strong> Create a <a href="https://github.com">free github account</a> if you don&#8217;t already have one
</strong> git can be downloaded from <a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git">git-scm.org</a></p>
</div>
<div class="ulist">
<ul>
<li>
<p>curl HTTP client</p>
<div class="ulist">
<ul>
<li>
<p>You could use any HTTP client of your choice. But we will use <strong>curl</strong> in our tutorial. Download latest version from <a href="https://curl.haxx.se/download.html">curl website</a></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="system-overview">System Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will be working with a simple "User Profile" app which we introduced in the <a href="https://docs.couchbase.com/userprofile-couchbase-mobile/standalone/userprofile/xamarin/userprofile_basic.html">Fundamentals Tutorial</a> and extended in the <a href="https://docs.couchbase.com/userprofile-couchbase-mobile/query/userprofile/xamarin/userprofile_query.html">Query Tutorial</a>.</p>
</div>
<div class="paragraph">
<p>In this tutorial, we will be extending that app to support data sync.</p>
</div>
<div class="paragraph">
<p>The app does the following</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Allows users to log in and create or update his/her user profile information. The user profile view is <em>automatically updated</em> everytime the profile information changes in the underlying database</p>
</li>
<li>
<p>The user profile information is synced with a remote Sync Gateway which then syncs it to other devices (subject to access control and routing configurations specified in the <code>sync function</code>)</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="../../assets/images/xamarin/userprofile_app_overview.gif" alt="App with Sync">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="app-installation">App Installation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="fetching-app-source-code">Fetching App Source Code</h3>
<div class="paragraph">
<p>You have two options</p>
</div>
<div class="sect3">
<h4 id="option-1-git-clone">Option 1 : Git Clone</h4>
<div class="ulist">
<ul>
<li>
<p>Clone the <strong><em>sync</em></strong> branch of the <code>User Profile Demo</code> project from GitHub. Type the following command in your terminal</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">  git clone -b sync https://github.com/couchbaselabs/userprofile-couchbase-mobile-xamarin.git</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="option-2-download-zip">Option 2 : Download .zip</h4>
<div class="ulist">
<ul>
<li>
<p>Download the  <code>User Profile Demo</code> project from <a href="https://github.com/couchbaselabs/userprofile-couchbase-mobile-xamarin/archive/sync.zip">here</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once all of the solution bits have been retrieved you can verify the installation, and run the app!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="try-it-out">Try it Out</h3>
<div class="ulist">
<ul>
<li>
<p>Open the <code>UserProfileDemo.sln</code>. The project would be located at <code>/path/to/UserProfileDemo/modules/userprofile/examples/src</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">open UserProfileDemo.sln</code></pre>
</div>
</div>
</li>
<li>
<p>Build and run the project using <strong>two simulators/emulators</strong>.</p>
</li>
<li>
<p>Verify that you see the login screen on both the simulators/emulators.</p>
<div class="imageblock">
<div class="content">
<img src="../../assets/images/xamarin/user_profile_login.png" alt="User Profile Login Screen Image">
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sync-gateway-2-x-installation">Sync Gateway 2.x Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are several <a href="https://developer.couchbase.com/documentation/mobile/2.0/installation/sync-gateway/index.html">deployment</a> options for the Sync Gateway. In our tutorial, we will be using the Sync Gateway installer to install the Sync Gateway on the same <em>localhost</em> as the mobile app.</p>
</div>
<div class="sect2">
<h3 id="download-the-installer">Download the Installer</h3>
<div class="ulist">
<ul>
<li>
<p>Download the latest Sync Gateway 2.x installer from <a href="https://www.couchbase.com/downloads#couchbase-mobile">Downloads</a> page. Be sure to select the <strong>"Mobile"</strong> tab.</p>
</li>
<li>
<p>Launch the Sync Gateway from the command line with the <strong>sync-gateway-config-userprofile-walrus.json</strong> config file. This file is bundled with the User Profile mobile App source that you downloaded as per instructions in <a href="#fetching-app-source-code">Fetching App Source Code</a> section. The <code>sync-gateway-config-userprofile-walrus.json</code> will be located in the <code>/path/to/UserProfileDemo/modules/userprofile/examples/src</code> folder</p>
<div class="paragraph">
<p>Type following commands in the command terminal -</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd  /path/to/sync-gateway-installation/couchbase-sync-gateway/bin

./sync_gateway /path/to/UserProfileDemo/content/modules/userprofile/examples/sync-gateway-config-userprofile-walrus.json</code></pre>
</div>
</div>
</li>
<li>
<p>You should see a many logs output to the console, similar to one below. For brevity, some of the log messages have been trimmed from output below</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">~/couchbase-sync-gateway/bin | =&gt; ./sync_gateway ~/projects/ios/UserProfileDemo/content/modules/userprofile/examples/sync-gateway-config-userprofile-walrus.json
2018-05-07T15:25:02.924-04:00 Enabling logging: [*]
2018-05-07T15:25:02.924-04:00 ==== Couchbase Sync Gateway/2.0.0(832;2d8a6c0) ====
2018-05-07T15:25:03.028-04:00     Created user "demo@example.com"
2018-05-07T15:25:03.028-04:00 Starting admin server on 127.0.0.1:4985
2018-05-07T15:25:03.028-04:00 Changes+: Notifying that "userprofile" changed (keys="{_sync:user:demo@example.com}") count=2
2018-05-07T15:25:03.028-04:00 Cache: Received #1 ("_user/demo@example.com")
2018-05-07T15:25:03.028-04:00 Cache: Initialized cache for channel "*" with options: &amp;{ChannelCacheMinLength:50 ChannelCacheMaxLength:500 ChannelCacheAge:1m0s}
2018-05-07T15:25:03.028-04:00 Cache:     #1 ==&gt; channel "*"
2018-05-07T15:25:03.028-04:00 Changes+: Notifying that "userprofile" changed (keys="{*}") count=3
2018-05-07T15:25:03.031-04:00 Starting server on :4984 ...</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now, let&#8217;s verify the installation</p>
</div>
</div>
<div class="sect2">
<h3 id="try-it-out-2">Try it Out</h3>
<div class="ulist">
<ul>
<li>
<p>Open a browser and enter <code><a href="http://localhost:4984" class="bare">http://localhost:4984</a></code> in the address bar</p>
</li>
<li>
<p>You should see a message similar one below</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">{"couchdb":"Welcome","vendor":{"name":"Couchbase Sync Gateway","version":"2.0"},"version":"Couchbase Sync Gateway/2.0.0(832;2d8a6c0)"}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution-overview">Solution Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The User Profile demo app is a Xamarin.Forms based solution that supports iOS, Android, and UWP mobile platforms. The solution utilizes various design patterns and principles such as <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93viewmodel">MVVM</a>, <a href="https://en.wikipedia.org/wiki/Inversion_of_control">IoC</a>, and the Repository Pattern.</p>
</div>
<div class="paragraph">
<p>The solution consists of seven projects.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>UserProfileDemo</strong>: A .NET Standard project responsible for maintaining view-level functionality.</p>
</li>
<li>
<p><strong>UserProfileDemo.Core</strong>: A .NET Standard project responsible for maintaining viewmodel-level functionality.</p>
</li>
<li>
<p><strong>UserProfileDemo.Models</strong>: A .NET Standard project consisting of simple data models.</p>
</li>
<li>
<p><strong>UserProfileDemo.Repositories</strong>: A .NET Standard project consisting of repository classes responsible for Couchbase Lite database initilization, interaction, etc.</p>
</li>
<li>
<p><strong>UserProfileDemo.iOS</strong>: A Xamarin.iOS platform project responsible for building the <code>.ipa</code> file.</p>
</li>
<li>
<p><strong>UserProfileDemo.Android</strong>: A Xamarin.Android platform project responsible for building the <code>.apk</code> file.</p>
</li>
<li>
<p><strong>UserProfileDemo.UWP</strong>: A UWP platform project responsible for building the <code>.exe</code> file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now that you have an understanding of the solution architecture let&#8217;s dive into the app!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="couchbase-lite-nuget">Couchbase Lite Nuget</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before diving into the code for the apps, it is important to point out the Couchbase Lite dependencies within the solution. The <a href="https://www.nuget.org/packages/Couchbase.Lite/">Couchbase.Lite Nuget package</a> is included as a reference within four projects of this solution:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>UserProfileDemo.Repositories</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>UserProfileDemo.iOS</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>UserProfileDemo.Android</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>UserProfileDemo.UWP</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>Couchbase.Lite</code> Nuget package contains the core functionality for Couchbase Lite. In the following sections you will dive into the capabilities it the package provides.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-model">Data Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If have followed along the tutorial on <a href="">Query Basics</a>, you can skip this section and proceed to the <a href="#sync-gateway-configuration">Sync Gateway Configuration</a>. section We have not made any changes to the Data model for this tutorial.
Couchbase Lite is a JSON <code>Document</code> Store. A <code>Document</code> is a logical collection of named fields and values.The values are any valid JSON types. In addition to the standard JSON types, Couchbase Lite supports some special types like <code>Date</code> and <code>Blob</code>.
While it is not required or enforced, it is a recommended practice to include a <em>"type"</em> property that can serve as a namespace for related.</p>
</div>
<div class="sect2">
<h3 id="the-user-profile-document">The "User Profile" Document</h3>
<div class="paragraph">
<p>The app deals with a single <code>Document</code> with a <em>"type"</em> property of <em>"user"</em>.  The document ID is of the form <em>"user::&lt;email&gt;"</em>.
An example of a document would be</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "type":"user",
    "name":"Jane Doe",
    "email":"jane.doe@earth.org",
    "address":"101 Main Street",
    "image":CBLBlob (image/jpg),
    "university":"Missouri State University"
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="userprofile">UserProfile</h3>
<div class="paragraph">
<p>The <em>"user"</em> Document is encoded to a <code>class</code> named <em>UserProfile</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">public class UserProfile
{
    public string type =&gt; "user";
    public string Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
    public string Address { get; set; }
    public byte[] ImageData { get; set; }
    public string Description { get; set; }
    public string University { get; set; }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-university-document">The "University" Document</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The app comes bundled with a collection of documents of type <em>"university"</em>. Each <code>Document</code> represents a university.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "type":"university","web_pages": [
      "http://www.missouristate.edu/"
    ],
    "name": "Missouri State University",
    "alpha_two_code": "US",
    "state-province": MO,
    "domains": [
      "missouristate.edu"
    ],
    "country": "United States"
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="universityrecord">UniversityRecord</h3>
<div class="paragraph">
<p>The <em>"university"</em> <code>Document</code> is encoded to a <code>class</code> named <em>University</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">public class University
{
    public string Name { get; set; }
    public string Country { get; set; }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sync-gateway-configuration">Sync Gateway Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/config-properties/index.html">Sync Gateway Configuration</a> determines the run time behavior of the Sync Gateway and is typically specified in a JSON file. You can also use the <a href="https://developer.couchbase.com/documentation/mobile/2.0/references/sync-gateway/admin-rest-api/index.html#/database/put<em>db</em>_config">Sync Gateway Config REST Endpoint</a> to specify the configuration. In our application, we will be defining it in the <code><strong>sync-gateway-config-userprofile-walrus.json</strong></code> file.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open the <code><strong>sync-gateway-config-userprofile-walrus.json</strong></code> file using any text editor of your choice. The <code>sync-gateway-config-userprofile-walrus.json</code> is located in the app bundle at <code>/path/to/UserProfileDemo/modules/userprofile/examples/src</code>.</p>
<div class="paragraph">
<p>Locate the following settings in the configuration file -</p>
</div>
</li>
<li>
<p>The <strong>users</strong> setting.</p>
<div class="paragraph">
<p>The list of  users recognized by the Sync Gateway is specified using the <code>users</code> config setting. The Sync Gateway will only authorize syncronization requests from valid/recognized users.</p>
</div>
<div class="paragraph">
<p>For simplicity, we have hardcoded the <code>user</code> to be <em>"<a href="mailto:demo@example.com">demo@example.com</a>"</em> and the <code>password</code> of <em>"password"</em>. In a production app, you would likely configure the user dynamically on the Sync Gateway through the <a href="https://developer.couchbase.com/documentation/mobile/2.0/references/sync-gateway/admin-rest-api/index.html#/user/post<em>db</em><em>user</em>">User Admin REST API</a> instead of hardcoding it this way.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">"userprofile": {
      "users": { "demo@example.com": { "password": "password"} },
      ....
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to want to use a different user, then add the credentials of that user to this configuration setting and restart the Sync Gateway.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>The <strong>server</strong> setting</p>
<div class="paragraph">
<p>This is where we specify the URL of the server. We have specified this to be <code><strong>walrus</strong></code>. This is an <em>in-memory-only</em> mode that is only recommended for development environments. We will be configuring Sync Gateway to operate in this mode.
In a production deployment, the Sync Gatway should be backed up by a Couchbase Server.</p>
</div>
<div class="paragraph">
<p>This is specified using the <code>server</code> config setting</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">"userprofile": {
      "server": "walrus:",
      ....
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>You can learn more about the walrus mode in this <a href="https://developer.couchbase.com/documentation/mobile/current/installation/sync-gateway/index.html#walrus-mode">guide</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sync-function">Sync Function</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Sync Function is a Javascript function that is specified as part of the <a href="#sync-gateway-configuration">Sync Gateway Configuration</a>. The Sync Function handles data validation, authorization, access control and data routing.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open the <code><strong>sync-gateway-config-userprofile-walrus.json</strong></code> file using any text editor of your choice. The <code>sync-gateway-config-userprofile-walrus.json</code> is located in the app bundle at <code>/path/to/UserProfileDemo/content/modules/userprofile/examples</code>.</p>
</li>
<li>
<p>Locate the <code>sync</code> setting and follow along with the rest of the sections below</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="authorization">Authorization</h3>
<div class="paragraph">
<p>We use the <a href="https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/sync-function-api-guide/index.html#requireuserusername"><code>requireUser()</code></a> API to verify that the <code>email</code> property specified in the Document matches the Id of the user making the request. The Id of the user making the request is specified in the <code>Authorization</code> header. We will be using <em>Basic Authentication</em> in our application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">function sync(doc, oldDoc) {
   ....
   /* Authorization */

  // Verify the user making the request is the same as the one in doc's email
  requireUser(doc.email);
  .....
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="data-validation">Data Validation</h3>
<div class="paragraph">
<p>In this case, we are doing some basic validation of the contents of the <code>Document</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">function sync(doc, oldDoc) {
   ...
   /* Data Validation */

   if (!isDelete()) {
      // Validate the presence of email fields
      validateNotEmpty("email", doc.email); <i class="conum" data-value="1"></i><b>(1)</b>

      // Check if document is being created / added for first time
      // We allow any user to create the document
      if (isCreate()) {

        // Validate that the document Id _id is prefixed by owner.
        var expectedDocId = "user" + "::" + doc.email;

        if (expectedDocId != doc._id) { <i class="conum" data-value="2"></i><b>(2)</b>
            throw({forbidden: "user doc Id must be of form user:email"});
        }

      } else {
         // Validate that the email hasn't changed.
        validateReadOnly("email", doc.email, oldDoc.email); <i class="conum" data-value="3"></i><b>(3)</b>
      }

    }


  // Verify that specified property exists
  function validateNotEmpty(key, value) {
    if (!value) {
      throw({forbidden: key + " is not provided."});
    }
  }

  // Verify that specified property value has not changed during update
  function validateReadOnly(name, value, oldValue) {
    if (value != oldValue) {
      throw({forbidden: name + " is read-only."});
    }
  }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Verify that the <code>email</code> property is not null. If it&#8217;s null, we throw a JS exception (see <code>validateNotEmpty()</code> function)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If this a new document, then verify that the <code>Id</code> of the Document is of the required format (i.e. <em>"user::&lt;email&gt;"</em>). We throw an exception if that&#8217;s not the case.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If this is a document update, then verify that the <code>email</code> property value has not changed. Again, we throw an exception if that&#8217;s not the case.</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>You can learn more about the Sync Function in this <a href="https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/sync-function-api-guide/index.htm">guide</a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="data-routing">Data Routing</h3>
<div class="paragraph">
<p><a href="https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/channels/index.html#introduction-to-channels"><code>channels</code></a> are a mechanism to "tag" documents and is typically used to seggregate documents based on the contents of the document. Combined with <a href="https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/sync-function-api-guide/index.html#access-username-channelname">access API</a> and <a href=""><code>requireAccess API</code></a>, it can be used to enforce <a href="#access-control">Access Control</a>. As we shall see in a later section, clients can use channels to pull only a subset of documents.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">  /* Routing */
  // Subsequent updates to document must be authorized
  var email = getEmail();

  // Add doc to the user's channel.
  channel("channel." + email); <i class="conum" data-value="1"></i><b>(1)</b>

  // get email Id property
  function getEmail() {
    return (isDelete() ? oldDoc.email : doc.email);
  }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The channel comes into existance the first time a document is added to it. In our case, the channel name is generated from the <code>email</code> property specified in the document</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="access-control">Access Control</h3>
<div class="paragraph">
<p>You can enforce access control to channels using the <a href="https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/sync-function-api-guide/index.html#access-username-channelname">access API</a>. This will ensure that only users with access to a specific channel will be able to retrieve documents in the channel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">  /* Access Control */
  // Give user read access to channel
   if (!isDelete()) {
    // Deletion of user document is essentially deletion of user
       access(email,"channel." + email)
   }</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="starting-replication">Starting Replication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Two-way Replication between the app and the Sync Gateway is enabled when user logs into the app.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open the <a href="https://github.com/couchbaselabs/userprofile-couchbase-mobile-xamarin/tree/sync/modules/userprofile/examples/src/UserProfileDemo.Repositories/DatabaseManager.cs"><strong>DatabaseManager.cs</strong></a> file and locate the <code>Start</code> method.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">public async Task StartReplicationAsync(string username,
                                        string password,
                                        string[] channels,
                                        ReplicatorType replicationType = ReplicatorType.PushAndPull,
                                        bool continuous = true)</code></pre>
</div>
</div>
</li>
<li>
<p>Next, we create an instance of the <code>ReplicatorConfig</code> instance that specifies the source and target database and you can optionally, override the default configuration settings.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">var configuration = new ReplicatorConfiguration(database, targetUrlEndpoint) <i class="conum" data-value="1"></i><b>(1)</b>
{
    ReplicatorType = replicationType, <i class="conum" data-value="2"></i><b>(2)</b>
    Continuous = continuous, <i class="conum" data-value="3"></i><b>(3)</b>
    Authenticator = new BasicAuthenticator(username, password), <i class="conum" data-value="4"></i><b>(4)</b>
    Channels = channels?.Select(x =&gt; $"channel.{x}").ToArray() <i class="conum" data-value="5"></i><b>(5)</b>
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initialize with <code>Source</code> as the local Couchbase Lite database and the <code>remote</code> target as the Sync Gateway</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replication <code>type</code> of <code>PushAndPull</code> indicates that we require two-way sync. A value of <code>.Pull</code> specifies that we only pull data from the Sync Gateway. A value of <code>.Push</code> specifies that we only push data.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>Continuous</code> mode is specified to be <em>true</em> which means that changes are synced in real-time. A value of <em>false</em>  which implies that data is only pulled from the Sync Gateway.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This is where you specify the authentication credentials of the user. In the <a href="#authorization">Authorization</a> section, we discussed that the Sync Gateway can enforce authorization check using the <code>RequireUser</code> API.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>Channels</code> are used to specify the channels to pull from. Only documents belonging to the specified channels are synced. This is subject to <a href="#access-control">Access Control</a> rights enforced at the Sync Gateway. This means that if a client does not have access to documents in a channel, the documents will not be synched even if the client specifies it in the replicator configuration.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Initialize the <code>Replicator</code> with the <code>ReplicatorConfiguration</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">_replicator = new Replicator(configuration);</code></pre>
</div>
</div>
</li>
<li>
<p>We attach a callback listener to the <code>Replicator</code> to be asynchronously notified of state changes. This could be useful for instance, to inform the user of the progress of the replication. This is an optional step</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">_replicator.AddChangeListener(OnReplicatorUpdate);</code></pre>
</div>
</div>
</li>
<li>
<p>Which is handled by a method called <code>OnReplicatorUpdate</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">void OnReplicatorUpdate(object sender, ReplicatorStatusChangedEventArgs e)
{
    var status = e.Status;

    switch (status.Activity)
    {
        case ReplicatorActivityLevel.Busy:
            Console.WriteLine("Busy transferring data.");
            break;
        case ReplicatorActivityLevel.Connecting:
            Console.WriteLine("Connecting to Sync Gateway.");
            break;
        case ReplicatorActivityLevel.Idle:
            Console.WriteLine("Replicator in idle state.");
            break;
        case ReplicatorActivityLevel.Offline:
            Console.WriteLine("Replicator in offline state.");
            break;
        case ReplicatorActivityLevel.Stopped:
            Console.WriteLine("Completed syncing documents.");
            break;
    }

    if (status.Progress.Completed == status.Progress.Total)
    {
        Console.WriteLine("All documents synced.");
    }
    else
    {
        Console.WriteLine($"Documents {status.Progress.Total - status.Progress.Completed} still pending sync");
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Start the replicator</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">_replicator.Start();</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stopping-replication">Stopping Replication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When user logs out of the app, the replication is stopped before the database is closed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open the <a href="https://github.com/couchbaselabs/userprofile-couchbase-mobile-xamarin/tree/sync/modules/userprofile/examples/src/UserProfileDemo.Repositories/DatabaseManager.cs"><strong>DatabaseManager.cs</strong></a> file and locate the <code>Stop</code> function.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">public void StopReplication()</code></pre>
</div>
</div>
</li>
<li>
<p>Stop the replicator and remove any associated change listeners</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">if (_replicator != null)
{
    _replicator.RemoveChangeListener(_replicatorListenerToken);
    _replicator.Stop();

    /*
    _replicator.Dispose();

    while (true)
    {
        if (_replicator.Status.Activity == ReplicatorActivityLevel.Stopped)
        {

            break;
        }
    }*/
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All open replicators must be stopped before database is closed. There will be an exception if you attempt to close the database without closing the active replicators.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="query-events-live-queries">Query Events / Live Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In couchbase Lite 2.0, the app can set up <em>live queries</em> in order to be asynchronously notified of changes to the database that affect the results of the query. This would be very useful for instance, to keep a UI View up-to-date with the results of a query.</p>
</div>
<div class="paragraph">
<p>In our app, the user profile view is kept up-to-date with a live query that fetches the user profile data that is used to populate the view. This means that, if the replicator pulls down changes to the user profile, it will be automatically reflected in the view.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open the <a href="https://github.com/couchbaselabs/userprofile-couchbase-mobile-xamarin/tree/sync/modules/userprofile/examples/src/UserProfileDemo.Repositories/UserProfileRepository.cs"><strong>UserProfileRepository.cs</strong></a> file and locate the <code>GetAsync</code> function. Calling this method and passing in a value for the <code>Func&lt;UserProfile,Task&gt;</code> named <code>onProfileUpdated</code> implies that the caller wishes to be notified of any changes to query results via delegation.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">public async Task&lt;UserProfile&gt; GetAsync(string userProfileId, Action&lt;UserProfile&gt; userProfileUpdated)</code></pre>
</div>
</div>
</li>
<li>
<p>Build the Query using <code>QueryBuilder</code> API. If you are unfamiliar with this API, please check out this <a href="https://developer.couchbase.com/documentation/mobile/2.0/userprofile_query.html">tutorial</a>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">_userQuery = QueryBuilder
                .Select(SelectResult.All())
                .From(DataSource.Database(database))
                .Where(Meta.ID.EqualTo(Expression.String(userProfileId))); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We query for documents based on document Id. In our app, there should be exactly one user profile document corresponding to this Id.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Attach listener callback to the query to make it <em>live</em></p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">                        _userQueryToken = _userQuery.AddChangeListener((object sender, QueryChangedEventArgs e) =&gt; <i class="conum" data-value="1"></i><b>(1)</b>
                        {
                            if (e?.Results != null &amp;&amp; e.Error == null)
                            {
                                foreach (var result in e.Results.AllResults())
                                {
                                    var dictionary = result.GetDictionary("userprofile"); <i class="conum" data-value="2"></i><b>(2)</b>

                                    if (dictionary != null)
                                    {
                                        userProfile = new UserProfile <i class="conum" data-value="3"></i><b>(3)</b>
                                        {
                                            Name = dictionary.GetString("name"), <i class="conum" data-value="4"></i><b>(4)</b>
                                            Email = dictionary.GetString("email"),
                                            Address = dictionary.GetString("address"),
                                            University = dictionary.GetString("university"),
                                            ImageData = dictionary.GetBlob("imageData")?.Content
                                        };
                                    }
                                }

                                if (userProfile != null)
                                {
                                    userProfileUpdated.Invoke(userProfile);
                                }
                            }
                        });</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Attach a listener callback to the query. Attaching a listerner automatically makes it <em>live</em> so any time there is a change in the user profile data in the underlying database, the callback would be invoked.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>SelectResult.all()</code> method is used to query all the properties of a document. In this case, the document in the result is embedded in a dictionary where the key is the database name, which is <em>"userprofiles"</em>. So, we retrieve the <a href="http://docs.couchbase.com/mobile/2.0/couchbase-lite-swift/Classes/DictionaryObject.html"><code>DictionaryObject</code></a> at key <em>"userprofiles"</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create an instance of <a href="#userprofile">UserProfile</a>. This will be populated with the query results.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We use appropriate <em>type getters</em> to retrieve values and populate the <em>UserProfile</em> instance</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="exercises">Exercises</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="exercise-1">Exercise 1</h3>
<div class="paragraph">
<p>In this exercise, we will observe how changes made on one app are synced across to the other app</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The app should be running in two simulators/emulators side by side</p>
</li>
<li>
<p>Log into both the simulators/emulators with same userId and password. Use the values <em>"<a href="mailto:demo@example.com">demo@example.com</a>"</em> and <em>"password"</em> for user Id and password fields respectively</p>
</li>
<li>
<p>On one simulator/emulator, enter values in the user and address fields.</p>
</li>
<li>
<p>Confirm that changes show up in the app on the other simulator/emulator.</p>
</li>
<li>
<p>Similarly, make changes to the app in the other simulator/emulator and confirm that the changes are synced over to the first simulator/emulator.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="exercise-2">Exercise 2</h3>
<div class="paragraph">
<p>In this exercise, we will observe changes made via Sync Gateway are synced over to the apps</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure you complete <a href="#exercise-1">Exercise 1</a>. This is to ensure that you have the appropriate user profile document (with document Id of "user::&lt;emailId&gt;") created through the app and synced over to the Sync Gateway.</p>
</li>
<li>
<p>Open the command terminal and issue the following command to get the user profile document via <a href="">GET Document REST API</a> . We will be using <code>curl</code> to issue the request. If you haven&#8217;t done so, please install curl as indicated in the <a href="#prerequisites">Prerequisites</a> section</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -X GET \
  http://localhost:4985/userprofile/user::demo@example.com \
  -H 'Accept: application/json' \
  -H 'Cache-Control: no-cache' \
  -H 'Content-Type: application/json'</code></pre>
</div>
</div>
</li>
<li>
<p>Your response should look something like the response below. The exact contents depends on the user profile information that you provided via your mobile app.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">{
    "_attachments": { <i class="conum" data-value="2"></i><b>(2)</b>
        "blob_1": {
            "content_type": "image/jpeg",
            "digest": "sha1-S8asPSgzA+F+fp8/2DdIy4K+0U8=",
            "length": 14989,
            "revpos": 2,
            "stub": true
        }
    },
    "_id": "user::demo@example.com",
    "_rev": "2-3a76cfa911e2c54d1e82b29dbffc7f4e5a9bc265", <i class="conum" data-value="1"></i><b>(1)</b>
    "address": "",
    "email": "demo@example.com",
    "image": {
        "@type": "blob",
        "content_type": "image/jpeg",
        "digest": "sha1-S8asPSgzA+F+fp8/2DdIy4K+0U8=",
        "length": 14989
    },
    "name": "",
    "type": "user",
    "university": "British Institute in Paris, University of London"
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Record the revision Id of the document. You will need this when you update the document</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If you had updated an image via the mobile app, you should see an <strong>"_attachments"</strong> property. This entry holds an array of attachments corresponding to each image blob entry added by the mobile app. This property is added by the Sync Gateway when it processes the document.  You can learn more about how image Blob types are mapped to attachments <a href="">here</a>.</td>
</tr>
</table>
</div>
</li>
<li>
<p>In the command terminal, issue the following command to update the user profile document via <a href="">PUT Document REST API</a></p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -X PUT \
  'http://localhost:4985/userprofile/user::demo@example.com?rev=3-12d203d6024c8b844c5ed736c726ac63379e05dc' \
  -H 'Accept: application/json' \
  -H 'Cache-Control: no-cache' \
  -H 'Content-Type: application/json' \
  -d '{
    "address": "101 Main Street", <i class="conum" data-value="1"></i><b>(1)</b>
    "email": "demo@example.com",
    "image": {
        "@type": "blob",
        "content_type": "image/jpeg",
        "digest": "sha1-S8asPSgzA+F+fp8/2DdIy4K+0U8=",
        "length": 14989
    },
    "name": "",
    "type": "user",
    "university": "British Institute in Paris, University of London"
}'</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>I updated the university field via the REST API. You can choose to update any other profile information</td>
</tr>
</table>
</div>
</li>
<li>
<p>Confirm that you get a HTTP <em>"201 Created"</em> status code</p>
</li>
<li>
<p>As soon as you update the document via the Sync Gateway REST API, confirm that the changes show up in the mobile app on the simulator/emulator.</p>
<div class="imageblock">
<div class="content">
<img src="../../assets/images/xamarin/sync_from_sgw.gif" alt="App Sync">
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
From <a href="#exercise-2">Exercise 2</a> above, you observed that changes made on the Sync Gateway are propagated to the Couchbase Lite clients. However, if you tried to update the attachment / image using the <a href="">Attachments REST API</a>, you would not see the image getting updated on the client side. This is a <a href="">known issue</a> in 2.0 and should be fixed in the next release.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="handling-conflicts-during-data-syncronization">Handling Conflicts during Data Syncronization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Data conflicts are inevtiable in an environment where you can potentially have multiple writes updating the same data concurrently. Couchbase Mobile 2.0 supports <em>Automated Conflict Resolution</em>.</p>
</div>
<div class="paragraph">
<p>You can learn more about automated conflict resolution in this <a href="https://blog.couchbase.com/document-conflicts-couchbase-mobile/">blog post</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="learn-more">Learn More</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Congratulations on completing this tutorial!</p>
</div>
<div class="paragraph">
<p>This tutorial walked you through an example of how to use a Sync Gateway to synchronize data between Couchbase Lite enabled clients. We discussed how to configure your Sync Gateway to enforce relevat access control, authorization and data routing between Couchbase Lite enabled clients.</p>
</div>
<div class="paragraph">
<p>Check out the following links for further details</p>
</div>
<div class="sect2">
<h3 id="further-reading">Further Reading</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/config-properties/index.html">Sync Gateway Configuration</a></p>
</li>
<li>
<p><a href="TBD">Sync Function API</a></p>
</li>
<li>
<p><a href="https://blog.couchbase.com/data-replication-couchbase-mobile/">Overview of Replication Protocol 2.0</a></p>
</li>
<li>
<p><a href="https://blog.couchbase.com/couchbase-mobile-docker/">Installing Sync Gateway using Docker</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-05-02 14:29:12 -0500
</div>
</div>
</body>
</html>